# Docker Compose configuration for ACP testing and development
# This sets up a complete test environment with ACP server and optional test services

services:
  # Main ACP server
  acp-server:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: acp-server
    ports:
      # Proxy port
      - "9443:9443"
      # Management API port
      - "9080:9080"
    volumes:
      # Persist ACP data between container restarts
      - acp-data:/var/lib/acp
      # Optional: mount CA certificate for host access
      - ./ca-cert.pem:/var/lib/acp/ca-cert.pem:ro
    environment:
      # Logging level (trace, debug, info, warn, error)
      - RUST_LOG=acp_server=info,acp_lib=info
      # Optional: Set password hash for testing (insecure, do not use in production!)
      # This is the SHA512 hash of "test-password" followed by Argon2 hashing
      # - ACP_PASSWORD_HASH=...
    # healthcheck is defined in Dockerfile
    restart: unless-stopped
    networks:
      - acp-network

  # Integration test runner
  # Runs comprehensive integration tests against the ACP server
  # Usage: docker compose up test-runner --build
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile.test-runner
    container_name: acp-test-runner
    depends_on:
      acp-server:
        condition: service_healthy
      mock-api:
        condition: service_started
    volumes:
      - ./smoke-tests/test-docker-integration.sh:/tests/test-docker-integration.sh:ro
    environment:
      - ACP_SERVER_URL=http://acp-server:9080
    networks:
      - acp-network
    profiles:
      - test

  # Mock upstream API for testing
  # Provides a simple echo/mirror service to test proxy behavior
  mock-api:
    image: mccutchen/go-httpbin
    container_name: acp-mock-api
    ports:
      - "8080:8080"
    networks:
      - acp-network
    restart: unless-stopped

volumes:
  # Persistent storage for ACP data
  # Contains: secrets, plugins, tokens, CA key
  acp-data:
    driver: local

networks:
  # Isolated network for ACP services
  acp-network:
    driver: bridge
